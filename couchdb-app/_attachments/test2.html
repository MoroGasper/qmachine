<!DOCTYPE html>
<!--
    test.html ~~
                                                        ~~ (c) SRW, 03 Sep 2011
-->
<html lang="en">
  <head>
    <meta charset="utf-8"/>
    <meta name="author" content="Sean Wilkinson"/>
    <title>Quanah: Test Page 2</title>
    <link rel="stylesheet" href="style.css"/>
    <link rel="shortcut icon" href="favicon.ico"/>
  </head>
  <body>
    <noscript>Please enable JavaScript in your browser.</noscript>
    <script>

     // Declarations

        var __DEBUG__, bookmarks, define;

        __DEBUG__ = false;

     // Constructors

        function QuanahVar(x) {
            var content, ready, revive, stack1, stack2, that;
            content = x;
            ready = true;
            revive = function () {
                var func;
                while ((func = stack1.shift()) !== undefined) {
                    try {
                        func.call(that, that.content);
                    } catch (err) {
                        if (err instanceof TryAgainLater) {
                            stack2.push(func);
                            if (__DEBUG__ === true) {
                                console.log(err.message);
                            }
                        } else {
                            console.log(err);
                        }
                    }
                }
                Array.prototype.push.apply(stack1,
                    stack2.splice(0, stack2.length));
            };
            stack1 = [];
            stack2 = [];
            that = this;
            define(that, "content", {
                configurable: false,
                enumerable: true,
                get: function () {
                    if (__DEBUG__ === true) {
                        console.log("(tripped getter)");
                    }
                    return content;
                },
                set: function (x) {
                    content = x;
                    if (__DEBUG__ === true) {
                        console.log("(tripped setter)");
                    }
                    return content;
                }
            });
            define(that, "onready", {
                configurable: false,
                enumerable: true,
                get: function () {
                 // This is intended to provide a means to inspect outstanding
                 // tasks that have not yet been applied to the content's value
                 // but JS pass-by-reference immediately implies that it could
                 // be used to modify the queue in-place ...
                    return (stack1.length === 0) ? null : stack1[0];
                },
                set: function (f) {
                    if ((f instanceof Function) && (typeof f === 'function')) {
                        stack1.push(f);
                        revive();
                    } else {
                        throw new Error('"onready" only accepts functions.');
                    }
                }
            });
            define(that, "type", {
                configurable: false,
                enumerable: true,
                value: "QuanahVar"
            });
            return that;
        }

        function TryAgainLater(message) {
            if (message.toString().length === 0) {
                this.message = "Dying ...";
            } else {
                this.message = message.toString();
            }
        }

        TryAgainLater.prototype = new Error();

     // Definitions

        if (location.port === "") {
         // This happens if we are actually using the rewrite rules I created
         // for my personal machine, but I haven't tested them on CouchOne ...
            bookmarks = {
                app:    location.href.replace(location.pathname, '/'),
                db:     location.href.replace(location.pathname, '/db/'),
                uuids:  location.href.replace(location.pathname,
                            '/_uuids?count=1000')
            };
        } else if (location.port === "5984") {
         // This is CouchDB's default debugging port, and the convention then
         // is to disable rewrite rules when using that port. In that case, I
         // have avoided hard-coding assumptions about the deployment target
         // by instead opting to navigate paths relative to the current URL.
            bookmarks = {
                app:    location.href.replace(location.pathname, '/') +
                            location.pathname.match(/([\w]+\/){3}/)[0],
                db:     location.href.replace(location.pathname, '/') +
                            location.pathname.match(/([\w]+\/){1}/)[0],
                uuids:  location.href.replace(location.pathname,
                            '/_uuids?count=1000')
            };
        } else {
         // Because this is still experimental, we may find problems.
            throw new Error("Relative path detection fell through.");
        }

        define = function (obj, key, params) {
            if (typeof Object.defineProperty === 'function') {
                define = function (obj, key, params) {
                    return Object.defineProperty(obj, key, params);
                };
            } else {
                define = function (obj, key, params) {
                    var each;
                    for (prop in params) {
                        if (params.hasOwnProperty(prop) === true) {
                            switch (prop) {
                            case "get":
                                obj.__defineGetter__(key, params[prop]);
                                break;
                            case "set":
                                obj.__defineSetter__(key, params[prop]);
                                break;
                            case "value":
                                delete obj[key];
                                obj[key] = params[each];
                                break;
                            default:
                             // (placeholder)
                            }
                        }
                    }
                    return obj;
                };
            }
            return define(obj, key, params);
        };

     // Invocations

        var x = new QuanahVar([1, 2, 3, 4, 5]);

        x.onready = function (x) {
            console.log(x.map(function (each) {
                return 3 * each;
            }));
        };

    </script>
  </body>
</html>
